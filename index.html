<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OQI Pilot Evaluation Input Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose-headings h2, .prose-headings h3 {
            margin-bottom: 0.5em;
        }
        .prose-p p {
            margin-top: 0.5em;
        }
        #modal-content ul {
            text-align: left;
            margin-top: 1rem;
            list-style-position: inside;
        }
        #modal-content li {
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto max-w-4xl px-4 py-8 md:py-12">
        <div class="mb-8 text-center">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAFeCAYAAAC0u/a9AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAFlqSURBVHhe7d0JvFTV+gfwo5D2EnoJaYgIAgoKggLq2IqIAoKCFVHsBYqIDQ4gAqIioI4dC/YQUFBRpCAIIigpEFLofUjvfL/N+SbzzZskCWl375vk9/X8+GTyTjJz7j1n5p7J2LAsy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy-7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Isy7Is-=" alt="GESDA Logo" alt="GESDA Logo" class="h-12 mx-auto">
        </div>
        
        <header class="mb-8 text-center">
            <div class="flex items-center space-x-3">
                <!-- NOTE: Update the src to the correct path for your GESDA logo -->
                <img src="gesda-logo.png" alt="GESDA Logo" class="h-10 w-auto">
                <span class="text-lg font-bold text-white hidden sm:block">AI & BCI Briefing</span>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-white">OQI Pilot Evaluation</h1>
            <p class="mt-2 text-lg text-gray-400">This tool is designed to gather structured feedback for the Open Quantum Institute's pilot phase evaluation.</p>
        </header>

        <form id="evaluationForm" class="bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg space-y-10">

            <!-- Section 1: Quality and Impact -->
            <fieldset class="space-y-6">
                <legend class="text-xl font-semibold text-white border-b border-gray-700 pb-2 w-full prose-headings">1. Quality and Impact of Results</legend>
                
                <div class="prose-headings prose-p">
                    <h3 class="text-lg font-medium text-gray-100">A. Scientific Relevance</h3>
                    <p id="desc_scientific" class="text-sm text-gray-400">OQI should follow state-of-the-art scientific methods and produce outputs contributing to science and awareness.</p>
                    <div class="mt-4">
                        <label id="label_scientific_quality" for="scientific_quality" class="block text-md font-medium text-gray-300 mb-2">Please comment on the scientific quality of OQI's tools, outputs, and educational materials.</label>
                        <textarea id="scientific_quality" name="scientific_quality" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                    <div class="mt-4">
                        <label id="label_scientific_messaging" for="scientific_messaging" class="block text-md font-medium text-gray-300 mb-2">Please comment on OQI's ability to relay robust scientific messages to the diplomatic community.</label>
                        <textarea id="scientific_messaging" name="scientific_messaging" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                     <div class="mt-2 text-right">
                        <button type="button" class="gemini-suggest-btn text-sm text-indigo-400 hover:text-indigo-300 font-medium" data-context-labels="label_scientific_quality,label_scientific_messaging" data-context-desc="desc_scientific">✨ Suggest Points</button>
                    </div>
                </div>
                
                <div class="prose-headings prose-p pt-4">
                    <h3 class="text-lg font-medium text-gray-100">B. Impact Relevance (SDGs)</h3>
                    <p id="desc_sdg" class="text-sm text-gray-400">OQI should contribute to progress towards the SDGs and enhance quantum readiness in underserved geographies.</p>
                    <div class="mt-4">
                        <label id="label_sdg_relevance" for="sdg_relevance" class="block text-md font-medium text-gray-300 mb-2">Comment on the relevance of use cases for the SDGs and their prospects for real-world impact.</label>
                        <textarea id="sdg_relevance" name="sdg_relevance" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                     <div class="mt-4">
                        <label id="label_underserved_regions" for="underserved_regions" class="block text-md font-medium text-gray-300 mb-2">Assess OQI's contribution to creating economic and innovation opportunities in underserved regions.</label>
                        <textarea id="underserved_regions" name="underserved_regions" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                    <div class="mt-2 text-right">
                        <button type="button" class="gemini-suggest-btn text-sm text-indigo-400 hover:text-indigo-300 font-medium" data-context-labels="label_sdg_relevance,label_underserved_regions" data-context-desc="desc_sdg">✨ Suggest Points</button>
                    </div>
                </div>
            </fieldset>

            <!-- Section 2: Cost and Sustainability -->
            <fieldset class="space-y-6">
                <legend class="text-xl font-semibold text-white border-b border-gray-700 pb-2 w-full prose-headings">2. Cost and Sustainability</legend>

                <div class="prose-headings prose-p">
                    <h3 class="text-lg font-medium text-gray-100">A. Efficient Use of Resources</h3>
                     <div class="mt-4">
                        <label id="label_resource_efficiency" for="resource_efficiency" class="block text-md font-medium text-gray-300 mb-2">Evaluate the overall resource use versus the outputs and impact achieved during the pilot.</label>
                        <textarea id="resource_efficiency" name="resource_efficiency" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                         <div class="mt-2 text-right">
                            <button type="button" class="gemini-suggest-btn text-sm text-indigo-400 hover:text-indigo-300 font-medium" data-context-labels="label_resource_efficiency" data-context-desc="">✨ Suggest Points</button>
                        </div>
                    </div>
                </div>
                
                <div class="prose-headings prose-p pt-4">
                    <h3 class="text-lg font-medium text-gray-100">B. Business Model & Sustainable Funding</h3>
                    <div class="mt-4">
                        <label id="label_funder_interest" for="funder_interest" class="block text-md font-medium text-gray-300 mb-2">Assess the level of interest from prospective funders and the sustainability of the business model.</label>
                        <textarea id="funder_interest" name="funder_interest" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                        <div class="mt-2 text-right">
                            <button type="button" class="gemini-suggest-btn text-sm text-indigo-400 hover:text-indigo-300 font-medium" data-context-labels="label_funder_interest" data-context-desc="">✨ Suggest Points</button>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Section 3: Community Support -->
            <fieldset class="space-y-6">
                <legend class="text-xl font-semibold text-white border-b border-gray-700 pb-2 w-full prose-headings">3. Community Support</legend>

                <div class="prose-headings prose-p">
                    <h3 class="text-lg font-medium text-gray-100">A. OQI Community Profile</h3>
                     <div class="mt-4">
                        <label id="label_community_representation" for="community_representation" class="block text-md font-medium text-gray-300 mb-2">Comment on the representation, balance, and influence of the four OQI communities (academic, diplomatic, business, philanthropy) and geographical representation.</label>
                        <textarea id="community_representation" name="community_representation" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                        <div class="mt-2 text-right">
                            <button type="button" class="gemini-suggest-btn text-sm text-indigo-400 hover:text-indigo-300 font-medium" data-context-labels="label_community_representation" data-context-desc="">✨ Suggest Points</button>
                        </div>
                    </div>
                </div>

                <div class="prose-headings prose-p pt-4">
                    <h3 class="text-lg font-medium text-gray-100">B. Support of the Quantum Community</h3>
                     <div class="mt-4">
                        <label id="label_quantum_community_support" for="quantum_community_support" class="block text-md font-medium text-gray-300 mb-2">Evaluate OQI's visibility, reputation, and perception within the broader quantum community.</label>
                        <textarea id="quantum_community_support" name="quantum_community_support" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                    <div class="mt-4">
                        <label id="label_cern_synergies" for="cern_synergies" class="block text-md font-medium text-gray-300 mb-2">Comment on the synergies between OQI and its host, CERN.</label>
                        <textarea id="cern_synergies" name="cern_synergies" rows="4" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                    <div class="mt-2 text-right">
                        <button type="button" class="gemini-suggest-btn text-sm text-indigo-400 hover:text-indigo-300 font-medium" data-context-labels="label_quantum_community_support,label_cern_synergies" data-context-desc="">✨ Suggest Points</button>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="space-y-4">
                <legend class="text-xl font-semibold text-white border-b border-gray-700 pb-2 w-full prose-headings">4. Your Information (Optional)</legend>
                <div>
                    <label for="respondent_name" class="block text-sm font-medium text-gray-300">Name</label>
                    <input type="text" id="respondent_name" name="respondent_name" class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                 <div>
                    <label for="respondent_affiliation" class="block text-sm font-medium text-gray-300">Affiliation / Role</label>
                    <input type="text" id="respondent_affiliation" name="respondent_affiliation" class="mt-1 block w-full p-2 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </fieldset>

            <!-- ✨ AI-Powered Summary -->
            <fieldset class="space-y-4">
                <legend class="text-xl font-semibold text-white border-b border-gray-700 pb-2 w-full prose-headings">✨ 5. AI-Generated Summary</legend>
                <p class="text-sm text-gray-400">Click the button below to generate a summary of all your feedback. You can review and edit it before submitting.</p>
                <div class="text-center">
                     <button type="button" id="generateSummaryBtn" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="summarySpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="summaryBtnText">✨ Generate Summary of My Feedback</span>
                    </button>
                </div>
                <div>
                    <label for="executive_summary" class="block text-sm font-medium text-gray-300">Generated Summary</label>
                    <textarea id="executive_summary" name="executive_summary" rows="6" class="mt-1 block w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-md shadow-sm transition" placeholder="Your generated summary will appear here..."></textarea>
                </div>
            </fieldset>


            <div class="flex justify-end pt-4">
                <button type="submit" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                    Submit Evaluation
                </button>
            </div>
        </form>
        
        <div id="statusMessage" class="hidden mt-6 p-4 rounded-md text-center"></div>
    </div>

    <!-- Gemini Suggestions Modal -->
    <div id="geminiModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div id="modal-spinner" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100">
                    <svg class="h-6 w-6 text-indigo-600 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-2">Generating Suggestions...</h3>
                <div id="modal-content" class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Please wait while we generate some ideas for you.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="closeModalBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // --- Gemini API Integration ---

        const API_KEY = ""; // Per instructions, leave this empty.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        async function callGeminiAPI(prompt, maxRetries = 3) {
            let attempt = 0;
            let delay = 1000; // Start with 1 second

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response structure");
                    }
                } catch (error) {
                    console.error(`API call failed on attempt ${attempt + 1}:`, error);
                    attempt++;
                    if (attempt < maxRetries) {
                        console.log(`Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        return "Sorry, we couldn't generate a response at this time. Please try again later.";
                    }
                }
            }
        }

        // --- UI Modal Logic ---
        const modal = document.getElementById('geminiModal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalSpinner = document.getElementById('modal-spinner');
        const closeModalBtn = document.getElementById('closeModalBtn');

        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            modal.classList.remove('hidden');
        }

        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));

        // --- "Suggest Points" Feature ---
        document.querySelectorAll('.gemini-suggest-btn').forEach(button => {
            button.addEventListener('click', async () => {
                showModal('Generating Suggestions...', '<p class="text-sm text-gray-500">Please wait while we generate some ideas for you.</p>');
                modalSpinner.classList.remove('hidden');

                const labelIds = button.dataset.contextLabels.split(',');
                const descId = button.dataset.contextDesc;
                
                const labels = labelIds.map(id => document.getElementById(id)?.textContent || '').filter(text => text);
                const description = descId ? document.getElementById(descId)?.textContent || '' : '';

                const prompt = `You are an expert consultant providing guidance for an organizational evaluation. A user needs help formulating their feedback for a specific section. Based on the following context, generate 3-4 insightful bullet points or questions to help them think. These should be starting points for their own detailed feedback. Format the output as a simple HTML list.

Evaluation Section Description: ${description}

Specific Questions in this section:
${labels.map(l => `- ${l}`).join('\n')}`;

                const suggestions = await callGeminiAPI(prompt);
                modalSpinner.classList.add('hidden');
                showModal('Suggested Talking Points', `<div class="text-sm text-gray-600">${suggestions}</div>`);
            });
        });

        // --- "Generate Summary" Feature ---
        const generateSummaryBtn = document.getElementById('generateSummaryBtn');
        const summarySpinner = document.getElementById('summarySpinner');
        const summaryBtnText = document.getElementById('summaryBtnText');
        const summaryTextarea = document.getElementById('executive_summary');

        generateSummaryBtn.addEventListener('click', async () => {
            summarySpinner.classList.remove('hidden');
            summaryBtnText.textContent = 'Generating...';
            generateSummaryBtn.disabled = true;

            const formData = new FormData(document.getElementById('evaluationForm'));
            let feedbackText = '';
            
            const feedbackMapping = {
                'Quality and Impact - Scientific Relevance': ['scientific_quality', 'scientific_messaging'],
                'Quality and Impact - Impact Relevance (SDGs)': ['sdg_relevance', 'underserved_regions'],
                'Cost and Sustainability - Efficient Use of Resources': ['resource_efficiency'],
                'Cost and Sustainability - Business Model & Sustainable Funding': ['funder_interest'],
                'Community Support - OQI Community Profile': ['community_representation'],
                'Community Support - Support of the Quantum Community': ['quantum_community_support', 'cern_synergies'],
            };

            for (const [title, ids] of Object.entries(feedbackMapping)) {
                const sectionText = ids.map(id => formData.get(id)).filter(text => text && text.trim() !== '').join('\n');
                if (sectionText) {
                    feedbackText += `### ${title}\n${sectionText}\n\n`;
                }
            }

            if (!feedbackText.trim()) {
                summaryTextarea.value = "Please fill out some of the feedback sections above before generating a summary.";
            } else {
                const prompt = `You are an expert analyst. A user has provided detailed feedback for the OQI Pilot Evaluation. Your task is to synthesize all of their responses into a coherent and concise executive summary of 2-3 paragraphs. Retain the core sentiment and key points from their original feedback.\n\n--- FEEDBACK DETAILS ---\n\n${feedbackText}\n--- END FEEDBACK ---\n\nNow, please generate the executive summary.`;
                const summary = await callGeminiAPI(prompt);
                summaryTextarea.value = summary;
            }

            summarySpinner.classList.add('hidden');
            summaryBtnText.textContent = '✨ Generate Summary of My Feedback';
            generateSummaryBtn.disabled = false;
        });


        // --- Original Form Submission Logic (Updated) ---
        const form = document.getElementById('evaluationForm');
        const statusMessage = document.getElementById('statusMessage');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const evaluationData = {
                scientific_quality: formData.get('scientific_quality'),
                scientific_messaging: formData.get('scientific_messaging'),
                sdg_relevance: formData.get('sdg_relevance'),
                underserved_regions: formData.get('underserved_regions'),
                resource_efficiency: formData.get('resource_efficiency'),
                funder_interest: formData.get('funder_interest'),
                community_representation: formData.get('community_representation'),
                quantum_community_support: formData.get('quantum_community_support'),
                cern_synergies: formData.get('cern_synergies'),
                respondent_name: formData.get('respondent_name'),
                respondent_affiliation: formData.get('respondent_affiliation'),
                executive_summary: formData.get('executive_summary'), // Added summary field
                submittedAt: new Date().toISOString()
            };

            console.log("Form data to be sent to backend:", evaluationData);
            
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700');
            statusMessage.classList.add('bg-blue-100', 'text-blue-700');
            statusMessage.textContent = 'Submitting...';

            try {
                // In a real application, you would replace the placeholder below
                // with your Firebase `addDoc` call.
                await new Promise(resolve => setTimeout(resolve, 1000)); 

                statusMessage.classList.remove('bg-blue-100', 'text-blue-700');
                statusMessage.classList.add('bg-green-100', 'text-green-700');
                statusMessage.textContent = 'Success! Thank you for your feedback.';
                form.reset();
            } catch (error) {
                console.error("Error submitting form: ", error);
                statusMessage.classList.remove('bg-blue-100', 'text-blue-700');
                statusMessage.classList.add('bg-red-100', 'text-red-700');
                statusMessage.textContent = 'Error: Could not submit feedback. Please try again.';
            } finally {
                 setTimeout(() => {
                    statusMessage.classList.add('hidden');
                 }, 5000);
            }
        });
    </script>

</body>
</html>



